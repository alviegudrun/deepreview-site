<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pricing ‚Äì DeepReview</title>
  <link rel="icon" type="image/svg+xml" href="../icons/icon.svg">
  <link rel="shortcut icon" href="../icons/icon.svg">
  <link rel="stylesheet" href="assets/style.css">
  <script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>
</head>
<body>
  <header class="site-header plain">
    <div class="container header-inner">
      <a class="brand" href="index.html">DeepReview</a>
      <nav class="nav">
        <a href="pricing.html" class="active">Pricing</a>
        <a href="terms.html">Terms</a>
        <a href="privacy.html">Privacy</a>
      </nav>
    </div>
  </header>

  <section class="section">
    <div class="container">
      <h1 class="section-title">Simple, transparent pricing</h1>
      <p class="muted center">Subscribe securely via Paddle. Taxes may apply in your region.</p>

      <div class="alert" style="margin:14px 0 0">
        <div><span class="highlight">Note:</span> If you already have a <b>Monthly</b> subscription, please <b>cancel it first</b> in the Customer Portal, then purchase the <b>Yearly</b> plan. Your current month access remains until the period end.</div>
        <div class="actions"><button class="btn btn-ghost" onclick="handleManageSubscription()">Open Customer Portal</button></div>
      </div>
      <div class="pricing-grid-single">
        <div class="card price">
          <div class="price-header">Free</div>
          <div class="price-value">$0</div>
          <ul class="price-features">
            <li>‚úÖ Unlimited monthly usage</li>
            <li>‚úÖ Support for predefined check rules</li>
            <li>‚úÖ Support for local deployment models</li>
            <li>‚úÖ Support for report export</li>
            <li>‚ùå Custom rules not supported</li>
            <li>‚ùå Parallel tasks not supported</li>
            <li>‚ùå Merge analysis not supported</li>
            <li>‚ùå Review mode not supported</li>
          </ul>
          <button class="btn btn-ghost full" onclick="handleFreeStart()">Get Started Free</button>
        </div>
        
        <div class="card price">
          <div class="price-header">DeepReview Pro</div>
          <div class="price-value">$5.99<span>/month</span></div>
          <ul class="price-features">
            <li>‚úÖ All Free features</li>
            <li>‚úÖ Custom rules, parallel tasks, merge analysis, review mode</li>
            <li>‚úÖ Priority support</li>
            <li>‚úÖ Early access to new features</li>
          </ul>
          <button class="btn btn-primary full" onclick="handleUpgrade('monthly')">Subscribe Monthly</button>
          <p class="pricing-note">Cancel anytime.</p>
        </div>
        
        <div class="card price featured">
          <div class="ribbon">Most Popular</div>
          <div class="price-header">DeepReview Pro</div>
          <div class="price-value">$59.90<span>/year</span></div>
          <ul class="price-features">
            <li>‚úÖ All Free features</li>
            <li>‚úÖ Custom rules, parallel tasks, merge analysis, review mode</li>
            <li>‚úÖ Priority support</li>
            <li>‚úÖ Early access to new features</li>
          </ul>
          <button class="btn btn-primary full" onclick="handleUpgrade('yearly')" id="upgrade-btn">Subscribe Yearly</button>
          <p class="pricing-note">Save over 15% compared to monthly.</p>
        </div>
      </div>

      <div class="center" style="margin:20px 0 8px">
        <button class="btn btn-ghost btn-lg" onclick="handleManageSubscription()">Manage / Cancel plan</button>
        <div class="note">Stops auto-renew at period end. Current period access is unaffected.</div>
      </div>

      <div class="pricing-faq">
        <h3>Frequently Asked Questions</h3>
        <details>
          <summary>Can I cancel anytime?</summary>
          <p>Yes, you can cancel your subscription at any time. Your access continues until the end of your billing period.</p>
        </details>
        <details>
          <summary>What are custom rules?</summary>
          <p>Create your own code review rules tailored to your team's specific standards and requirements.</p>
        </details>
        <details>
          <summary>How does parallel processing work?</summary>
          <p>Process multiple files simultaneously for faster review times, especially beneficial for large codebases.</p>
        </details>
        <details>
          <summary>What is merge analysis?</summary>
          <p>Analyze related files as a whole to validate overall logic and cross-file dependencies.</p>
        </details>
      </div>

      <div class="note center">
        We highly value all user experiences, and all basic features are open to the free version.<br>
        For teams or enterprise licenses, contact us: <a href="mailto:alviegudrun@gmail.com">alviegudrun@gmail.com</a><br>
        Thank you for your support! üôè
      </div>
    </div>
  </section>

  <!-- Payment Processing Modal -->
  <div id="payment-modal" class="payment-modal hidden">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Processing Payment...</h3>
        <button class="modal-close" onclick="closePaymentModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="payment-status">
          <div class="spinner"></div>
          <p id="payment-status-text">Initializing payment...</p>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-inner">
      <div><strong>DeepReview</strong></div>
      <nav class="footer-nav">
        <a href="terms.html">Terms</a>
        <a href="privacy.html">Privacy</a>
        <a href="refund.html">Refund</a>
      </nav>
    </div>
  </footer>

  <script>
    // Environment toggle: set to 'sandbox' or 'live' (or via ?env=live)
    const DR_ENV = (new URLSearchParams(location.search).get('env')) || 'sandbox';

    // Centralized Paddle environment configuration
    const ENV_CONFIG = {
      sandbox: {
        token: 'test_4b05d1a77a742bd77ffa74e3c30',
        products: {
          yearly: 'pri_01k3a39jpkydhhwra9ne1s797m',
          monthly: 'pri_01k3a38rw99kgp3g64n2accx14'
        },
        paddleEnv: 'sandbox'
      },
      live: {
        token: 'live_9ecb2f70961454470867728f006',
        products: {
          yearly: 'pri_01k39w7nmf4vd3rn1byb6p8ny6',
          monthly: 'pri_01k39wh6ex2ddg4bt2v5vh53ym'
        },
        paddleEnv: 'production'
      }
    };
    const ACTIVE = ENV_CONFIG[DR_ENV] || ENV_CONFIG.sandbox;

    // Paddle configuration (resolved from ACTIVE)
    const PADDLE_CONFIG = {
      vendorId: '42232',
      environment: DR_ENV,
      products: ACTIVE.products
    };
    
    // Debug: Log the exact Price IDs we're using
    console.log('Price IDs configured:', PADDLE_CONFIG.products);
    
    // Global token definition (resolved from ACTIVE)
    const PADDLE_CLIENT_TOKEN = ACTIVE.token;

    // Initialize Paddle (token-based)
    document.addEventListener('DOMContentLoaded', function() {
      if (typeof Paddle !== 'undefined') {
        const env = PADDLE_CLIENT_TOKEN.startsWith('live_') ? 'production' : 'sandbox';
        try {
          // Ensure environment per docs
          if (ACTIVE.paddleEnv && Paddle.Environment && typeof Paddle.Environment.set === 'function') {
            Paddle.Environment.set(ACTIVE.paddleEnv);
          }
          const paramsForInit = getUrlParams ? getUrlParams() : {};
          const pw = (DR_ENV === 'live' && paramsForInit && paramsForInit.email) ? { email: paramsForInit.email } : undefined;
          const initOptions = pw ? { token: PADDLE_CLIENT_TOKEN, pwCustomer: pw } : { token: PADDLE_CLIENT_TOKEN };
          Paddle.Initialize(initOptions);
          console.log('Paddle initialized with token, env:', env);
          
          // Add event listeners for debugging
          if (Paddle.Events && typeof Paddle.Events.on === 'function') {
            Paddle.Events.on('checkout.loaded', function(e) { 
              console.log('üéâ Paddle checkout loaded:', e); 
            });
            Paddle.Events.on('checkout.completed', function(e) { 
              console.log('‚úÖ Paddle checkout completed:', e); 
            });
            Paddle.Events.on('checkout.closed', function(e) { 
              console.log('‚ùå Paddle checkout closed:', e); 
            });
            console.log('Event listeners added');
          } else {
            console.log('Paddle.Events not available or different API');
          }
        } catch (e) {
          console.error('Paddle Initialize failed:', e);
        }
      } else {
        console.error('Paddle.js not loaded');
      }
    });

    function getUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      return {
        email: urlParams.get('email'),
        plan: urlParams.get('plan'),
        flowId: urlParams.get('flowId'),
        userName: urlParams.get('userName') || '',
        userSub: urlParams.get('userSub') || ''
      };
    }

    function handleFreeStart() {
      // Redirect to Chrome Web Store or direct download
      alert('Please install the DeepReview extension from the Chrome Web Store to get started.');
    }

    // Open Paddle Customer Portal for self-serve cancel/management
    function handleManageSubscription() {
      // You can maintain separate portals for sandbox/live if desired
      const portal = DR_ENV === 'live'
        ? 'https://customer-portal.paddle.com/cpl_01k2pvmfqhyaqtxmfcr99nhvw0'
        : 'https://sandbox-customer-portal.paddle.com/cpl_01k3a321v5f11mvch9z8901v9d';
      try {
        window.open(portal, '_blank', 'noopener');
      } catch (_) {
        location.href = portal;
      }
    }

    function handleUpgrade(plan) {
      const params = getUrlParams();
      const userEmail = params.email || prompt('Please enter your email address:');
      const userName = params.userName || '';
      const userSub = params.userSub || '';
      const flowId = params.flowId || `web_${Date.now()}`;
      
      if (!userEmail) {
        alert('Email address is required to proceed with upgrade.');
        return;
      }

      if (!PADDLE_CONFIG.products[plan]) {
        alert('Product configuration error. Please contact support.');
        return;
      }

      // Validate email format
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(userEmail)) {
        alert('Please enter a valid email address.');
        return;
      }

      showPaymentModal();
      updatePaymentStatus('Initializing payment...');

      console.log('Starting payment flow:', {
        plan,
        userEmail,
        userName,
        flowId,
        productId: PADDLE_CONFIG.products[plan]
      });

      // Configure Paddle checkout
      Paddle.Checkout.open({
        items: [{ priceId: PADDLE_CONFIG.products[plan], quantity: 1 }],
        customer: { email: userEmail },
        settings: {
          displayMode: 'overlay',
          theme: 'light',
          allowLogout: false,
          locale: 'en'
        },
        
        // Custom data for webhook processing
        customData: {
          user_email: userEmail,
          ...(userName && { user_name: userName }),
          ...(userSub && { user_sub: userSub }),
          plan: plan,
          source: 'extension',
          flow_id: flowId,
          extension_version: '1.1.2',
          timestamp: new Date().toISOString()
        }
      });

      // Start monitoring the overlay so our spinner is hidden at the right time
      monitorCheckoutOverlay();
      
      console.log('‚úÖ Paddle checkout opened successfully');
    }

    function showPaymentModal() {
      document.getElementById('payment-modal').classList.remove('hidden');
    }

    function closePaymentModal() {
      document.getElementById('payment-modal').classList.add('hidden');
    }

    function updatePaymentStatus(message) {
      document.getElementById('payment-status-text').textContent = message;
    }

    // Hide our processing modal when Paddle overlay appears or is closed
    function monitorCheckoutOverlay() {
      // Poll briefly for the overlay iframe to show, then hide our spinner
      const start = Date.now();
      const maxWaitMs = 8000;
      const interval = setInterval(() => {
        const overlay = document.querySelector('iframe[src*="paddle"]');
        const isHidden = document.querySelector('#payment-modal.hidden');
        if (overlay && !isHidden) {
          closePaymentModal();
          clearInterval(interval);
          return;
        }
        if (Date.now() - start > maxWaitMs) {
          clearInterval(interval);
        }
      }, 300);

      // Best effort: if Paddle provides Events, also close on checkout.closed
      if (window.Paddle && Paddle.Events && typeof Paddle.Events.on === 'function') {
        try {
          Paddle.Events.on('checkout.closed', function(){ closePaymentModal(); });
          Paddle.Events.on('checkout.loaded', function(){ closePaymentModal(); });
        } catch(_){}
      }
    }

    function handlePaymentSuccess(data) {
      updatePaymentStatus('Subscription activated successfully!');
      
      setTimeout(() => {
        closePaymentModal();
        
        // Show success message
        const message = `üéâ Welcome to DeepReview Pro!

Your subscription is now active. You can:
‚Ä¢ Close this page and return to the extension
‚Ä¢ The extension will automatically detect your Pro status
‚Ä¢ Enjoy unlimited features!

Thank you for your support! üôè`;
        
        alert(message);
        
        // Try to close window or redirect
        if (window.opener) {
          window.close();
        } else {
          // Redirect to success page
          window.location.href = 'index.html?success=true';
        }
      }, 3000);
    }

    function showProcessingNotice() {
      const message = `Payment Processing Notice

Your payment may still be processing. 

What to do next:
‚Ä¢ Return to the extension and wait a few minutes
‚Ä¢ The extension will automatically detect your subscription status
‚Ä¢ If you don't see Pro features after 10 minutes, please contact support

Thank you for your patience!`;
      
      alert(message);
    }

    // Auto-trigger upgrade if parameters are present
    document.addEventListener('DOMContentLoaded', function() {
      const params = getUrlParams();
      if (params.plan && params.email) {
        console.log('Auto-triggering upgrade with params:', params);
        // Small delay to ensure Paddle is loaded
        setTimeout(() => {
          handleUpgrade(params.plan);
        }, 1000);
      }
    });

    // Handle success redirect from index page
    if (window.location.search.includes('success=true')) {
      document.addEventListener('DOMContentLoaded', function() {
        const successBanner = document.createElement('div');
        successBanner.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          background: #10b981;
          color: white;
          text-align: center;
          padding: 1rem;
          z-index: 1000;
          font-weight: 500;
        `;
        successBanner.textContent = 'üéâ Payment successful! Your DeepReview Pro subscription is now active.';
        document.body.appendChild(successBanner);
        
        setTimeout(() => {
          successBanner.remove();
        }, 10000);
      });
    }
  </script>

  <style>
    .pricing-grid-single {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 2rem;
      max-width: 800px;
      margin: 0 auto;
    }

    .price-trial {
      color: #059669;
      font-weight: 500;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    .pricing-note {
      font-size: 0.8rem;
      color: #6b7280;
      margin-top: 0.5rem;
      text-align: center;
    }

    .pricing-faq {
      margin-top: 3rem;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }

    .pricing-faq h3 {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .pricing-faq details {
      margin-bottom: 1rem;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      padding: 1rem;
    }

    .pricing-faq summary {
      font-weight: 500;
      cursor: pointer;
      margin-bottom: 0.5rem;
    }

    .pricing-faq details[open] summary {
      margin-bottom: 1rem;
    }

    .payment-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .payment-modal.hidden {
      display: none;
    }

    .modal-content {
      background: white;
      border-radius: 0.5rem;
      max-width: 400px;
      width: 90%;
      overflow: hidden;
    }

    .modal-header {
      padding: 1rem;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
    }

    .modal-body {
      padding: 2rem;
    }

    .payment-status {
      text-align: center;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f3f4f6;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</body>
</html> 
